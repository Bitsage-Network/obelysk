name: Deploy Contracts

on:
  workflow_dispatch:
    inputs:
      contract:
        description: "Contract to deploy"
        required: true
        type: choice
        options:
          - shielded_swap_router
          - confidential_transfer
          - dark_pool_auction
          - stealth_registry
          - privacy_router
          - vm31_confidential_bridge
          - all
      network:
        description: "Target network"
        required: true
        type: choice
        options:
          - sepolia
          - mainnet
        default: sepolia

jobs:
  validate:
    name: Validate & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: software-mansion/setup-scarb@v1
        with:
          scarb-version: "2.12.0"

      - name: Build contracts
        run: cd contracts && scarb build

      - name: Verify artifacts exist
        run: |
          echo "Checking contract artifacts..."
          ls -la contracts/target/dev/*.contract_class.json
          ls -la contracts/target/dev/*.compiled_contract_class.json
          echo "All artifacts present"

      - uses: actions/upload-artifact@v4
        with:
          name: contract-artifacts
          path: contracts/target/dev/
          retention-days: 30

  deploy-contracts:
    name: Declare & Deploy (${{ inputs.network }})
    needs: validate
    runs-on: ubuntu-latest
    environment: ${{ inputs.network }}
    steps:
      - uses: actions/checkout@v4

      - uses: software-mansion/setup-scarb@v1
        with:
          scarb-version: "2.12.0"

      - uses: foundry-rs/setup-snfoundry@v5.0.0

      - uses: actions/download-artifact@v4
        with:
          name: contract-artifacts
          path: contracts/target/dev/

      - name: Mainnet safety check
        if: inputs.network == 'mainnet'
        run: |
          echo "============================================"
          echo "  MAINNET DEPLOYMENT REQUESTED"
          echo "============================================"
          echo ""
          echo "Contract: ${{ inputs.contract }}"
          echo "Deployer: ${{ secrets.DEPLOYER_ADDRESS }}"
          echo ""
          echo "Pre-deployment checklist:"
          echo "  [x] Contract built from validated artifacts"
          echo "  [ ] Audit findings resolved (verify manually)"
          echo "  [ ] Upgrade delay set to >= 48 hours"
          echo "  [ ] Multisig ownership transfer planned"
          echo ""
          echo "Verifying mainnet configuration..."
          echo "Deployment will proceed with 48h upgrade timelock"

      - name: Setup sncast account
        run: |
          mkdir -p contracts/deployment
          if [ "${{ inputs.network }}" = "mainnet" ]; then
            PROFILE="alpha-mainnet"
            RPC_URL="${{ secrets.MAINNET_RPC_URL }}"
          else
            PROFILE="alpha-sepolia"
            RPC_URL="${{ secrets.SEPOLIA_RPC_URL }}"
          fi
          # Write account file with restricted permissions
          umask 077
          cat > contracts/deployment/sncast_accounts.json << EOF
          {
            "$PROFILE": {
              "deployer": {
                "address": "${{ secrets.DEPLOYER_ADDRESS }}",
                "private_key": "${{ secrets.DEPLOYER_PRIVATE_KEY }}",
                "public_key": "${{ secrets.DEPLOYER_PUBLIC_KEY }}",
                "type": "open_zeppelin",
                "salt": "0x0"
              }
            }
          }
          EOF
          chmod 600 contracts/deployment/sncast_accounts.json

      - name: Declare & Deploy
        working-directory: contracts
        env:
          CONTRACT: ${{ inputs.contract }}
          NETWORK: ${{ inputs.network }}
          DEPLOYER_ADDRESS: ${{ secrets.DEPLOYER_ADDRESS }}
        run: |
          set -euo pipefail

          if [ "$NETWORK" = "mainnet" ]; then
            RPC_URL="${{ secrets.MAINNET_RPC_URL }}"
            UPGRADE_DELAY=172800
          else
            RPC_URL="${{ secrets.SEPOLIA_RPC_URL }}"
            UPGRADE_DELAY=300
          fi

          SNCAST="sncast --account deployer --accounts-file deployment/sncast_accounts.json --url $RPC_URL"
          PACKAGE="obelysk_contracts"

          declare_and_deploy() {
            local contract_name="$1"
            shift
            local calldata="$*"

            echo "=== Declaring $contract_name ==="
            local declare_output
            declare_output=$($SNCAST declare --contract-name "$contract_name" 2>&1) || true

            # Parse class hash from output (handles both fresh declare and already-declared)
            CLASS_HASH=$(echo "$declare_output" | grep -oP 'class_hash: \K0x[0-9a-fA-F]+' || true)
            if [ -z "$CLASS_HASH" ]; then
              # "already declared" — extract hash from error message without re-declaring
              CLASS_HASH=$(echo "$declare_output" | grep -oP '0x[0-9a-fA-F]{50,}' | head -1 || true)
            fi

            if [ -z "$CLASS_HASH" ]; then
              echo "ERROR: Failed to declare $contract_name"
              echo "Output: $declare_output"
              exit 1
            fi
            echo "Class hash: $CLASS_HASH"

            # Validate class hash format
            if [[ ! "$CLASS_HASH" =~ ^0x[0-9a-fA-F]+$ ]]; then
              echo "ERROR: Invalid class hash format: $CLASS_HASH"
              exit 1
            fi

            echo "=== Deploying $contract_name ==="
            local deploy_output
            if [ -n "$calldata" ]; then
              deploy_output=$($SNCAST deploy --class-hash "$CLASS_HASH" --constructor-calldata $calldata 2>&1)
            else
              deploy_output=$($SNCAST deploy --class-hash "$CLASS_HASH" 2>&1)
            fi

            ADDR=$(echo "$deploy_output" | grep -oP 'contract_address: \K0x[0-9a-fA-F]+' || true)
            if [ -z "$ADDR" ]; then
              echo "ERROR: Failed to deploy $contract_name"
              echo "Output: $deploy_output"
              exit 1
            fi

            # Validate address format
            if [[ ! "$ADDR" =~ ^0x[0-9a-fA-F]+$ ]]; then
              echo "ERROR: Invalid contract address format: $ADDR"
              exit 1
            fi

            echo "Deployed at: $ADDR"
            echo "${contract_name}_ADDRESS=$ADDR" >> "$GITHUB_ENV"
            echo "${contract_name}_CLASS_HASH=$CLASS_HASH" >> "$GITHUB_ENV"
          }

          # ─── Contract dispatch ───
          case "$CONTRACT" in
            confidential_transfer)
              declare_and_deploy "ConfidentialTransfer" "$DEPLOYER_ADDRESS" "0x0" "0x0" "$UPGRADE_DELAY"
              ;;
            dark_pool_auction)
              declare_and_deploy "DarkPoolAuction" "$DEPLOYER_ADDRESS"
              ;;
            stealth_registry)
              declare_and_deploy "StealthRegistry" "$DEPLOYER_ADDRESS" "${{ secrets.SAGE_TOKEN_ADDRESS }}"
              ;;
            privacy_router)
              declare_and_deploy "PrivacyRouter" "$DEPLOYER_ADDRESS" "${{ secrets.SAGE_TOKEN_ADDRESS }}" "0x0"
              ;;
            shielded_swap_router)
              if [ "$NETWORK" = "mainnet" ]; then
                EKUBO="0x00000005dd3d2f4429af886cd1a3b08289dbcea99a294197e9eb43b0e0325b4b"
              else
                EKUBO="0x0444a09d96389aa7148f1aada508e30b71299ffe650d9c97fdaae38cb9a23384"
              fi
              declare_and_deploy "ShieldedSwapRouter" "$DEPLOYER_ADDRESS" "$EKUBO"
              ;;
            vm31_confidential_bridge)
              declare_and_deploy "VM31ConfidentialBridge" "$DEPLOYER_ADDRESS" "0x0" "0x0" "${{ secrets.CONFIDENTIAL_TRANSFER_ADDRESS }}"
              ;;
            all)
              echo "For full deployment, use: contracts/scripts/deploy-mainnet.sh"
              echo "CI 'all' deployment is not supported — deploy contracts individually."
              exit 1
              ;;
            *)
              echo "Unknown contract: $CONTRACT"
              exit 1
              ;;
          esac

          echo "=== Deployment complete ==="

      - name: Cleanup secrets
        if: always()
        run: |
          rm -f contracts/deployment/sncast_accounts.json
          echo "Account credentials cleaned up"

      - name: Verify deployment
        if: success()
        working-directory: contracts
        run: |
          echo "=== Post-deploy verification ==="
          # Log all deployed addresses from env for audit trail
          env | grep -E '_(ADDRESS|CLASS_HASH)=' | sort || echo "No deployment env vars found"
